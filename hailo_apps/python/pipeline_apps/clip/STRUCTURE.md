# CLIP Directory Structure

## Main Folder (clip/)
```
clip/
├── README.md                # Application usage documentation
├── README_SETUP.md          # Complete setup documentation
├── STRUCTURE.md            # This file - directory structure guide
├── clip_text_utils.py      # Main utility functions (uses setup/ files)
├── clip_app.py            # Full CLIP application
├── embeddings.json        # Generated embeddings (from build_sample_embeddings_json.py)
└── setup/                 # Setup scripts and generated files
    ├── generate_tokenizer.py                # Step 1: Generate tokenizer
    ├── generate_token_embedding_lut.py      # Step 2: Generate token embeddings
    ├── generate_text_projection.py          # Step 3: Generate text projection
    ├── build_sample_embeddings_json.py      # Step 4: Generate sample embeddings JSON
    ├── clip_tokenizer.json                  # Generated (3.5 MB)
    ├── token_embedding_lut.npy              # Generated (97 MB)
    └── text_projection.npy                  # Generated (1 MB)
```

## Key Changes

1. **All generator scripts** → Moved to `setup/` folder
2. **All generated files** → Stored in `setup/` folder (except embeddings.json)
3. **clip_text_utils.py** → Updated to look for files in `setup/`
4. **embeddings.json** → Generated in main folder by `setup/build_sample_embeddings_json.py`
5. **README files** → Merged into single `README_SETUP.md` in main folder

## Setup Process

### Step 1-3: Generate Core Files (Required)
```bash
cd setup
python3 generate_tokenizer.py
python3 generate_token_embedding_lut.py
python3 generate_text_projection.py
```

These files are required for the text encoder to work.

### Step 4: Generate Sample Embeddings (Optional)
```bash
cd setup
python3 build_sample_embeddings_json.py
```

This creates `embeddings.json` in the parent directory with pre-computed embeddings for:
- person
- sea
- dog
- cat
- snake
- (empty strings for padding)

**Important:** Running this script **overwrites** existing `embeddings.json`. Back up custom embeddings first!

## Usage

### Generate Files (One-Time)
```bash
cd setup
python3 generate_tokenizer.py
python3 generate_token_embedding_lut.py
python3 generate_text_projection.py

# Optional: Generate sample embeddings JSON
python3 build_sample_embeddings_json.py
```

### Use in Code
```python
# clip_text_utils.py automatically uses setup/ folder
from clip_text_utils import run_text_encoder_inference

# Real-time text encoding
text_features = run_text_encoder_inference(
    text="A photo of a cat",
    hef_path="clip_vit_b_32_text_encoder.hef"
)

# Or use pre-computed embeddings from JSON
import json
with open('embeddings.json', 'r') as f:
    embeddings = json.load(f)
```

## File Purposes

### Core Files (in `setup/`)

| File | Purpose | Generated By | Required |
|------|---------|--------------|----------|
| `clip_tokenizer.json` | Text → Token IDs | `generate_tokenizer.py` | Yes |
| `token_embedding_lut.npy` | Token IDs → Embeddings | `generate_token_embedding_lut.py` | Yes |
| `text_projection.npy` | Encoder output → Final embeddings | `generate_text_projection.py` | Yes |

### Configuration Files (in main folder)

| File | Purpose | Generated By | Required |
|------|---------|--------------|----------|
| `embeddings.json` | Pre-computed text embeddings | `build_sample_embeddings_json.py` | Optional |

**Note:** The `embeddings.json` format:
```json
{
  "threshold": 0.5,
  "text_prefix": "A photo of a ",
  "ensemble_template": ["a photo of a {}.", ...],
  "entries": [
    {
      "text": "cat",
      "embedding": [0.024, -0.063, ...],
      "negative": false,
      "ensemble": false
    }
  ]
}
```

## Benefits

✓ Clean separation of setup vs runtime code
✓ Generated files organized in one place
✓ Easy to gitignore the entire setup/ folder if needed
✓ Clear documentation in main folder
✓ Pre-computed embeddings for faster runtime performance
✓ Easy to customize sample embeddings by editing `build_sample_embeddings_json.py`

## Workflow

1. **Initial Setup** (one-time):
   - Generate tokenizer, embedding LUT, text projection
   - Optionally generate sample embeddings JSON

2. **Development** (as needed):
   - Modify `build_sample_embeddings_json.py` to customize sample texts
   - Re-run to regenerate `embeddings.json` (backs up manually if needed)

3. **Runtime**:
   - Use `clip_text_utils.py` for real-time text encoding
   - OR load pre-computed embeddings from `embeddings.json` for faster startup
   - Application uses either approach based on `--disable-runtime-prompts` flag
