import json
import sys
from pathlib import Path
import numpy as np

from hailo_apps.python.core.common.core import get_resource_path
from hailo_apps.python.core.common.defines import CLIP_TEXT_ENCODER_PIPELINE, RESOURCES_MODELS_DIR_NAME

# Add parent directory to path to import clip_text_utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from clip_text_utils import run_text_encoder_inference

if __name__ == '__main__':
    # Configuration
    hef_path = get_resource_path(pipeline_name=CLIP_TEXT_ENCODER_PIPELINE, resource_type=RESOURCES_MODELS_DIR_NAME)
    timeout_ms = 1000
    json_output_path = '../embeddings.json'
    
    # Text entries to encode
    text_entries = ['person', 'sea', 'dog', 'cat', 'snake']
    
    # Configuration for the embeddings JSON
    config = {
        "threshold": 0.5,
        "text_prefix": "A photo of a ",
        "ensemble_template": [
            "a photo of a {}.",
            "a photo of the {}.",
            "a photo of my {}.",
            "a photo of a big {}.",
            "a photo of a small {}."
        ],
        "entries": []
    }
    
    # Process each text entry
    print(f"Processing {len(text_entries)} text entries...")
    for text in text_entries:
        print(f"Processing: {text}")
        
        # Run inference to get normalized embeddings
        embedding = run_text_encoder_inference(
            text=text,
            hef_path=hef_path,
            timeout_ms=timeout_ms
        )
        
        # Convert to list (embedding shape is (1, embedding_dim) for single text)
        embedding_list = embedding[0].tolist()
        
        # Add entry to config
        config["entries"].append({
            "text": text,
            "embedding": embedding_list,
            "negative": False,
            "ensemble": False
        })
    
    # Add empty entries (as shown in the example JSON)
    for _ in range(2):
        # Get embedding for empty string
        empty_embedding = run_text_encoder_inference(
            text="",
            hef_path=hef_path,
            timeout_ms=timeout_ms
        )
        empty_embedding_list = empty_embedding[0].tolist()
        
        config["entries"].append({
            "text": "",
            "embedding": empty_embedding_list,
            "negative": False,
            "ensemble": False
        })
    
    # Save to JSON file
    output_path = Path(__file__).parent / json_output_path
    with open(output_path, 'w') as f:
        json.dump(config, f, indent=None)  # Compact format like the example
    
    print(f"\nEmbeddings saved to: {output_path}")
    print(f"Total entries: {len(config['entries'])}")
    print(f"Embedding dimension: {len(config['entries'][0]['embedding'])}")